<script>
  (function() {
    const hideRedundantReviews = () => {
      const reviews = document.querySelectorAll('.jdgm-rev');
      reviews.forEach(rev => {
        const authorEl = rev.querySelector('.jdgm-rev__author');
        const titleEl = rev.querySelector('.jdgm-rev__title');
        const bodyEl = rev.querySelector('.jdgm-rev__body');

        if (!authorEl) return;

        const author = authorEl.innerText.trim().toLowerCase();

        // Hide title if it matches author
        if (titleEl) {
          const title = titleEl.innerText.trim().toLowerCase();
          if (title === author) {
            titleEl.style.setProperty('display', 'none', 'important');
          }
        }

        // Hide body if it matches author
        if (bodyEl) {
          const body = bodyEl.innerText.trim().toLowerCase();
          if (body === author) {
            bodyEl.style.setProperty('display', 'none', 'important');
          }
        }
      });
    };

    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.addedNodes.length) {
          hideRedundantReviews();
        }
      });
    });

    const scrollToReviews = () => {
      const reviewsSection = document.querySelector('#judgeme_product_reviews');
      if (!reviewsSection) return;

      const getOffset = () => {
        const headerHeight = parseInt(
          getComputedStyle(document.documentElement).getPropertyValue('--header-height')
        ) || 80;
        return headerHeight + 20;
      };

      const getTargetScrollTop = () =>
        reviewsSection.getBoundingClientRect().top + window.pageYOffset - getOffset();

      window.scrollTo({ top: getTargetScrollTop(), behavior: 'smooth' });

      let lastKnownTop = getTargetScrollTop();
      let stableCount = 0;
      const startTime = Date.now();

      const checkPosition = () => {
        if (Date.now() - startTime > 5000) return;

        const currentTop = getTargetScrollTop();
        if (Math.abs(currentTop - lastKnownTop) > 5) {
          window.scrollTo({ top: currentTop, behavior: 'smooth' });
          lastKnownTop = currentTop;
          stableCount = 0;
        } else {
          stableCount++;
        }

        if (stableCount < 20) {
          requestAnimationFrame(checkPosition);
        }
      };

      requestAnimationFrame(checkPosition);
    };

    const interceptBadgeScroll = () => {
      document.querySelectorAll('.jdgm-prev-badge__text, .jdgm-prev-badge a[href*="judgeme_product_reviews"]').forEach(el => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          scrollToReviews();
        }, true);
      });
    };

    const initBadgeScroll = () => {
      const badge = document.querySelector('.jdgm-prev-badge__text');
      if (badge) {
        interceptBadgeScroll();
      } else {
        setTimeout(initBadgeScroll, 500);
      }
    };

    const init = () => {
      const target = document.querySelector('#judgeme_product_reviews');
      if (target) {
        observer.observe(target, { childList: true, subtree: true });
        hideRedundantReviews();
      } else {
        // Retry if the widget container isn't in the DOM yet
        setTimeout(init, 500);
      }
      initBadgeScroll();
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>
